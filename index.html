<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Resultados Alcaldía Cali 2023</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Storytelling interactivo de los resultados de la elección de Alcaldía de Cali 2023: mapa, choropleth, barras apiladas y puestos de votación con D3.js." />

  <!-- CSS -->
  <link rel="stylesheet" href="css/main.css?v=4.0" />

  <!-- Librerías (defer para no bloquear el parseo) -->
  <script defer src="https://d3js.org/d3.v7.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
</head>
<body>
  <noscript>
    <div class="noscript">
      Esta visualización requiere JavaScript habilitado.
    </div>
  </noscript>

  <header class="page-header">
    <h1 class="title">Resultados Elecciones Alcaldía Cali 2023</h1>
    <p class="subtitle">Desplázate para avanzar en la historia</p>
  </header>

  <main id="graphic" class="graphic" aria-live="polite">
    <!-- Vis panel (pegajoso) -->
    <section id="vis" class="vis" aria-label="Visualización principal">
      <div id="chart-container" class="chart-container">
        <!-- Placeholders que el motor poblará según la escena -->
        <svg id="map-svg" class="map-svg" aria-label="Mapa de comunas"></svg>
        <div id="legend" class="legend" aria-label="Leyenda"></div>
        <div id="bars-container" class="bars-container"></div>
      </div>

      <!-- Tooltip global reutilizable -->
      <div id="tooltip" class="tooltip" role="tooltip" aria-hidden="true"></div>

      <!-- Indicador de progreso (opcional, se puede estilizar en CSS) -->
      <div id="progress" class="progress" aria-hidden="true">
        <div class="progress-bar"></div>
      </div>
    </section>

    <!-- Texto narrativo (pasos del scrollytelling) -->
    <aside id="sections" class="sections" aria-label="Narrativa por pasos">
      <section class="step" id="step0" data-step="0">
        <h2>Introducción</h2>
        <p>Explora cómo votó Cali en 2023. Desplázate para avanzar.</p>
      </section>

      <section class="step" id="step1" data-step="1">
        <h2>Mapa de comunas</h2>
        <p>Mostramos las comunas de Cali con sus límites oficiales.</p>
      </section>

      <section class="step" id="step2" data-step="2">
        <h2>Choropleth por ganador</h2>
        <p>Coloreamos por ganador de la comuna (Eder = amarillo, Ortiz = rojo) y mostramos la intensidad por porcentaje.</p>
      </section>

      <section class="step" id="step3" data-step="3">
        <h2>Barras apiladas por comuna</h2>
        <p>Distribución de votos por candidato y categorías (incluye %_otros).</p>
      </section>

      <section class="step" id="step4" data-step="4">
        <h2>Puestos de votación</h2>
        <p>Círculos georreferenciados (borrador) con información contextual.</p>
      </section>

      <section class="step last" id="step5" data-step="5">
        <h2>Conclusiones</h2>
        <p>Resumen de resultados y comparaciones clave.</p>
      </section>
    </aside>
  </main>

  <footer class="page-footer">
    <small>Fuente: Registraduría Nacional (procesamiento propio). Hecho con D3.js.</small>
  </footer>

  <!-- Módulos (orden: componentes → motor → utilidades/scroll → escenas → responsive) -->
  <script defer src="js/stackedBar.js?v=4.0"></script>
  <script defer src="js/engineCali.js?v=4.0"></script>
  <script defer src="js/scroller_util.js?v=4.0"></script>
  <script defer src="js/scroller.js?v=4.0"></script>
  <script defer src="js/sections.js?v=4.0"></script>
  <script defer src="js/responsive.js?v=4.0"></script>

  <!-- Loader de datos y arranque -->
  <script>
  window.addEventListener("DOMContentLoaded", function () {
    const DATA = {
      votosPuestos: "data/votos.csv",
      votosComunas: "data/votos_comunas.csv",
      geoComunas: "geo/cali_polygon.geojson"
    };

    Promise.all([
      d3.csv(DATA.votosPuestos, d3.autoType),
      d3.json(DATA.geoComunas),
      d3.csv(DATA.votosComunas, d3.autoType)
    ])
    .then(([puestos, caliGeo, comunasAgg]) => {
      if (typeof initSections === "function") {
        initSections(puestos, caliGeo, comunasAgg);
      } else {
        console.error("initSections no está definido. ¿Cargaste sections.js?");
      }
    })
    .catch(err => {
      console.error("Error cargando datos:", err);
      const tooltip = document.getElementById("tooltip");
      if (tooltip) {
        tooltip.textContent = "Error cargando datos. Revisa rutas y formato.";
        tooltip.classList.add("visible", "error");
        tooltip.setAttribute("aria-hidden", "false");
      }
    });
  });
</script>
</body>
</html>
